<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Invest Instruments Admin</title>
  <link rel="stylesheet" href="/static/style.css" />
</head>
<body>
  <h1>Управление бумагами и настройками</h1>
  <section>
    <h2>Настройки</h2>
    <form method="post" action="/settings/update">
      <label><input type="checkbox" name="auto_fetch" {% if auto_fetch %}checked{% endif %}/> Авто-дозагрузка прогнозов</label><br/>
      <label>Макс. consensus на uid: <input type="number" name="max_consensus_per_uid" value="{{ limits.max_consensus_per_uid }}" /></label><br/>
      <label>Макс. targets (uid,company): <input type="number" name="max_targets_per_analyst" value="{{ limits.max_targets_per_analyst }}" /></label><br/>
      <label>Макс. возраст (дней): <input type="number" name="max_history_days" value="{{ limits.max_history_days }}" /></label><br/>
      <button type="submit">Сохранить</button>
    </form>
  </section>
  <section>
    <h2>Бумаги</h2>
    <form method="post" action="/shares/add">
      <input type="text" name="query" placeholder="тикер или название" required />
      <button type="submit" {% if not token_set %}disabled title="Токен не задан"{% endif %}>Добавить</button>
    </form>
    <table>
      <thead>
        <tr><th>UID</th><th>Ticker</th><th>Название</th><th></th></tr>
      </thead>
      <tbody>
      {% for s in shares %}
        <tr>
          <td>{{ s.uid }}</td>
          <td>{{ s.ticker }}</td>
          <td>{{ s.name }}</td>
          <td>
            <form method="post" action="/shares/delete" style="display:inline" onsubmit="return confirm('Удалить бумагу и связанные прогнозы?');">
              <input type="hidden" name="uid" value="{{ s.uid }}" />
              <label style="font-size:0.8em"><input type="checkbox" name="delete_forecasts" checked /> prog</label>
              <button type="submit">Удалить</button>
            </form>
          </td>
        </tr>
      {% endfor %}
      </tbody>
    </table>
  </section>
  <section>
    <h2>Быстрый просмотр прогнозов (последние 5 записей на инструмент)</h2>
    <details>
      <summary>Показать</summary>
      <div id="forecasts"></div>
    </details>
  </section>
  <section>
    <h2>Действия</h2>
    <form method="post" action="/actions/ensure">
      <button type="submit" {% if not token_set %}disabled title="Токен не задан"{% endif %}>Ensure forecasts</button>
    </form>
  </section>
  <section>
    <h2>Логи</h2>
    <pre id="logs" style="max-height:300px;overflow:auto;background:#111;color:#eee;padding:8px;font-size:12px;"></pre>
  </section>
  <script>
    async function loadLogs(){
      try { const r = await fetch('/logs'); if(r.ok){ document.getElementById('logs').textContent = await r.text(); }} catch(e){}
    }
    async function loadForecasts(){
      const container = document.getElementById('forecasts');
      container.innerHTML='Загрузка...';
      const rows = [];
      const shareRows = Array.from(document.querySelectorAll('tbody tr')); 
      for (const tr of shareRows.slice(0,15)) { // ограничим чтобы не перегружать
        const uid = tr.children[0].textContent.trim();
        try {
          const r = await fetch(`/api/forecasts/${uid}`); if(!r.ok) continue; const data = await r.json();
          const f = data.forecasts.map(x=>`${x.recommendationDate||''} ${x.recommendation||''} pc=${x.priceConsensus??''}`).slice(0,5).join('<br/>');
          rows.push(`<tr><td>${uid}</td><td>${f||'(нет)'}</td></tr>`);
        } catch(e){}
      }
      container.innerHTML = `<table><thead><tr><th>UID</th><th>Consensus (recent)</th></tr></thead><tbody>${rows.join('')}</tbody></table>`;
    }
    loadLogs();
    loadForecasts();
    setInterval(loadLogs, 10000);
  </script>
</body>
</html>
