# Инструменты для данных MOEX и консенсус‑прогнозов

Минимальный набор утилит для локальной SQLite‑БД `GorbunovInvestInstruments.db`:
1. Синхронная загрузка и поддержание исторических цен MOEX (скользящее окно ~1100 дней, очистка старых строк).
2. Получение и обновление консенсус‑прогнозов и целей аналитиков через публичный API Тинькофф.
3. Расчёт потенциалов (daily уникальность по `(uid, computedDate)`).
4. Экспорт потенциалов в Excel / JSON.
5. Оркестрация единым скриптом `full_refresh.py`.

## Требования

- Python 3.11+
- Зависимости перечислены в `requirements.txt`

Установка зависимостей:

```
pip install -r requirements.txt
```

## Быстрый старт (полный цикл)

```powershell
python full_refresh.py
```

Скрипт выполнит (пошагово):
1. Проверка и догрузка отсутствующих историй цен (скользящее окно).
2. Инкрементальное обновление цен за последние дни.
3. Загрузка/дозагрузка консенсус‑прогнозов (если есть токен).
4. Пересчёт потенциалов.
5. Экспорт (Excel всегда, JSON опционально через переменную окружения).

Токен берётся из переменной окружения `TINKOFF_INVEST_TOKEN`, если отсутствует — из файла `tinkoff_token.txt` (первая непустая строка). Полный токен в логе не выводится (маскируется).

Автоматизированные скрипты:
- Windows BAT: `run_full_refresh.bat` (создание venv, зависимости, лог ротация `refresh_YYYYMMDD.log`).
- PowerShell: `full_refresh.ps1` (доп. параметры `-ShowLogTail`, `-ForceInstall`, `-AllowInsecure`).

### Переменные окружения для full_refresh

| Переменная | Назначение | По умолчанию |
| --- | --- | --- |
| `TINKOFF_INVEST_TOKEN` | Токен API Тинькофф | (читается из файла если не задан) |
| `FULL_REFRESH_EXPORT_JSON` | 1 = сохранять JSON экспорт потенциалов | 0 |
| `FULL_REFRESH_EXCEL_NAME` | Имя Excel файла | potentials_export.xlsx |
| `FULL_REFRESH_JSON_NAME` | Имя JSON файла (если включён) | potentials_export.json |
| `PRICE_LIMIT_INSTRUMENTS` | Ограничить число бумаг при загрузке цен | (нет) |
| `PRICE_GLOBAL_TIMEOUT_SEC` | Прервать загрузку цен по тайм‑ауту | (нет) |
| `TINKOFF_CA_BUNDLE` | Путь к кастомному CA bundle (SSL) | (системный) |
| `TINKOFF_SSL_NO_VERIFY` | 1 = отключить проверку TLS (диагностика) | 0 |

### Диагностика SSL проблем
При ошибке вида `CERTIFICATE_VERIFY_FAILED`:
1. (Временно) проверить, работает ли с отключением: `$env:TINKOFF_SSL_NO_VERIFY='1'; python full_refresh.py`
2. Извлечь корневой сертификат(ы) в PEM: поместите файл `tinkoff_ca_bundle.pem` (приоритет) или `corp_ca.pem` в корень — скрипты подхватят автоматически.
3. Либо указать путь явно: `$env:TINKOFF_CA_BUNDLE='D:\certs\corp_ca.pem'`.
4. Удалить переменную `TINKOFF_SSL_NO_VERIFY` после диагностики.

Отключение проверки SSL (не для продакшена):
- Переменная окружения: `TINKOFF_SSL_NO_VERIFY=1`
- PowerShell флаг: `./full_refresh.ps1 -AllowInsecure`
- Файл-флаг в корне: `disable_ssl_verify.flag` (создайте пустой файл — оба скрипта отключат проверку)

Всегда удаляйте/убирайте эти механизмы после выяснения причин проблемы.

### Экспорт
Excel содержит «умную» таблицу с подсветкой стилей; JSON (если включён) повторяет набор данных.

### Потенциалы
`potentials.compute_all` формирует/обновляет таблицу с ключом `(uid, computedDate)` и относительным потенциалом на основе последней доступной цены (`CLOSE`) из `moex_history_perspective_shares` и consensus target/consensus price (формула упрощена в коде). Старый столбец `computedAt` удалён для дедупликации.

### Планирование (Windows Task Scheduler)
Используйте `run_full_refresh.bat` или PowerShell вариант:
```
powershell -NoProfile -ExecutionPolicy Bypass -File full_refresh.ps1 -ShowLogTail
```
Задайте ежедневный триггер. Логи: `refresh_YYYYMMDD.log`.

### Разница: update vs fill

- `--fill-consensus` — первоначальное накопление данных (история не чистится).
- `--update-consensus` — регулярное обновление с обрезкой: максимум 300 consensus и 100 target записей + возрастной порог (числа настраиваются переменными окружения / флагами CLI).

### Переменные окружения (консенсус)

| Переменная | Назначение | Значение по умолчанию |
| --- | --- | --- |
| `TINKOFF_INVEST_TOKEN` | Токен авторизации API | (нет, требуется) |
| `API_TIMEOUT` | Таймаут запроса (сек) | 15 |
| `API_MAX_ATTEMPTS` | Повторных попыток при ошибках | 3 |
| `API_BACKOFF_BASE` | Базовый backoff (сек) | 0.5 |
| `APP_LOG_LEVEL` | Уровень логирования | INFO |
| `APP_LOG_FILE` | Имя лог-файла | app.log |
| `APP_DISABLE_SSL_VERIFY` | 1 = отключить проверку TLS (dev) | 0 |
| `CONSENSUS_MAX_PER_UID` | Лимит consensus записей на uid | 300 |
| `CONSENSUS_MAX_TARGETS_PER_ANALYST` | Лимит целей на (uid, company) | 100 |
| `CONSENSUS_MAX_HISTORY_DAYS` | Порог дней для возрастной очистки | 1000 |
| `CONSENSUS_AUTO_FETCH` | 1=авто дозагрузка при старте и добавлении новой бумаги | 1 |

---

## Исторические цены MOEX
Реализованы в модуле `GorbunovInvestInstruments/data_prices.py`:
- Таблица `moex_history_perspective_shares`
- Пагинация ISS (`start` параметр)
- Скользящее окно (удаление записей старше горизонта)
- Инкрементальная догрузка
- Ограничение по времени/количеству бумаг через `PRICE_LIMIT_INSTRUMENTS`, `PRICE_GLOBAL_TIMEOUT_SEC`

### Источник цен для потенциалов
Берётся последняя `CLOSE` на дату пересчёта. При каждом полном обновлении выполняется `compute_all`.

## Планировщик (Windows Task Scheduler)

Для ежедневного обновления (например, в 08:30):
1. Откройте Планировщик заданий -> Создать задачу.
2. Триггер: Ежедневно, время 08:30.
3. Действие: Запустить программу.
  - Программа/скрипт: `python`
  - Аргументы: `full_refresh.py`
  - Рабочая папка: путь к каталогу проекта.
4. Вкладка «Условия»: при необходимости снять галочку «Запускать только при питании от сети».
5. Вкладка «Параметры»: включить «Запустить задачу как можно скорее после пропуска». 

Логи пишутся в `app.log`. При необходимости можно задать перенаправление вывода в файл .bat:
```
python full_refresh.py >> refresh.log 2>&1
```

### Структура таблицы `moex_history_perspective_shares`

Хранит необходимые поля ответа ISS (BOARDID, SECID, TRADEDATE, CLOSE, VOLUME и др.) + дублирует дату в `TRADE_SESSION_DATE`.
Ключ не навязан средствами UNIQUE — дубликаты избегаются логикой вставки `WHERE NOT EXISTS`.

### Метрики

Возвращаемая структура при пакетном обновлении содержит:
```
{
  "total_inserted": N,
  "total_deleted_old": M,
  "http_requests": X,
  "retries": R,
  "per_security": { "SBER": {"inserted": ..., "deleted_old": ...}, ... }
}
```

### Тестирование

Добавлен модульный тест `test_prev_close.py`, который проверяет извлечение последней цены из новой таблицы.

---

## Пример запуска hello.py

Артефакт примера `hello.py` оставлен для совместимости:

```
python hello.py
```

---

Все сообщения логирования и комментарии локализованы на русский язык. Модули, связанные с legacy (web UI / async), удалены.
